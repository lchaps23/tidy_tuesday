---
title: "Brazilian Companies"
format: html
theme: cosmo
toc: true
toc-depth: 3
number-sections: true
number-depth: 3
embed-resources: true
dpi: 900
---

```{r}
#| label: setup
#| include: false

library(tidyverse)
library(tidytuesdayR)
library(DT)
library(NatParksPalettes)
library(ggridges)
library(scales)

options(DT.options = list(pageLength = 10))
```

# Getting the data

```{r}
#| label: getting_data
#| warning: false

source("../get_data.R")

companies      <- get_data("2026-01-27", "companies")
legal_nature   <- get_data("2026-01-27", "legal_nature")
qualifications <- get_data("2026-01-27", "qualifications")
size           <- get_data("2026-01-27", "size")
```

# Which legal nature categories concentrate the highest total and average stock capital?

```{r}
#| label: stock_capital_legal_nature

ln_stock_capital <- companies |> 
  
  group_by(legal_nature) |> 
  
  summarise(
    companies       = n(),
    total_cap_stock = sum(capital_stock),
    mean_cap_stock  = mean(capital_stock),
    med_cap_stock   = median(capital_stock)
  ) |> 
  
  arrange(desc(mean_cap_stock))

ln_stock_capital |> 
  
  rename(
    "Legal Nature"         = "legal_nature",
    "Companies"            = "companies",
    "Total Capital Stock"  = "total_cap_stock",
    "Mean Capital Stock"   = "mean_cap_stock",
    "Median Capital Stock" = "med_cap_stock"
  ) |> 
  
  datatable(
    options = list(
      autowidth    = TRUE,
      orderClasses = TRUE
    )
  ) |> 
  
  formatCurrency(
    columns  = c("Total Capital Stock",
                 "Mean Capital Stock",
                 "Median Capital Stock"),
    currency = "R$",
    digits   = 2
  )
```

# How does company size relate to capital stock (and how skewed is it)?

```{r}
#| label: company_sizes

company_size_stock <- companies |> 
  
  group_by(company_size) |> 
  
  summarise(
    companies = n(),
    total_cap_stock = sum(capital_stock),
    mean_cap_stock  = mean(capital_stock),
    med_cap_stock   = median(capital_stock) 
  ) |> 
  
  arrange(desc(mean_cap_stock))
  
company_size_stock |> 
  
  rename(
    "Company Size"         = "company_size",
    "Companies"            = "companies",
    "Total Capital Stock"  = "total_cap_stock",
    "Mean Capital Stock"   = "mean_cap_stock",
    "Median Capital Stock" = "med_cap_stock"
  ) |> 
  
  datatable(
    options = list(
      autowidth    = TRUE,
      orderClasses = TRUE
    )
  ) |> 
  
  formatCurrency(
    columns  = c("Total Capital Stock",
                 "Mean Capital Stock",
                 "Median Capital Stock"),
    currency = "R$",
    digits   = 2
  )
```

```{r}
#| label: company_sizes_distribution_plot

ggplot(companies, 
       aes(x = capital_stock, 
           y = company_size, 
           fill = company_size)) +
  
  geom_density_ridges(
    alpha = 0.7, 
    scale = 0.9
  ) +
  
  geom_segment(
    data = company_size_stock,
    aes(x = mean_cap_stock, 
        xend = mean_cap_stock,
        y = as.numeric(factor(company_size)),
        yend = as.numeric(factor(company_size)) + 0.9),
    colour = "red", 
    linetype = "dashed", 
    linewidth = 0.7,
    inherit.aes = FALSE
  ) +
  
  geom_segment(
    data = company_size_stock,
    aes(x = med_cap_stock, 
        xend = med_cap_stock,
        y = as.numeric(factor(company_size)),
        yend = as.numeric(factor(company_size)) + 0.9),
    colour = "blue", 
    linetype = "dashed", 
    linewidth = 0.7,
    inherit.aes = FALSE
  ) +
  
  scale_x_log10(labels = label_number(scale = 1e-9, suffix = "B")) +
  
  labs(
    x     = "Capital Stock (Billions, log scale)",
    y     = "Company Size",
    title = "Distribution of Capital Stock by Company Size",
    caption = "Blue dashed = median  |  Red dashed = mean | "
  ) +
  
  theme_minimal() +
  
  theme(legend.position = "none")

```

# Do specific owner qualification groups dominate high-capital companies?

```{r}
#| label: high_stock_companies

high_stock_companies <- companies |> 
  
  filter(capital_stock >= quantile(capital_stock, 0.9))

owner_quals_high_stock <- high_stock_companies |> 
  
  group_by(owner_qualification) |> 
  
  summarise(
    companies = n(),
    total_cap_stock = sum(capital_stock),
    mean_cap_stock  = mean(capital_stock),
    med_cap_stock   = median(capital_stock) 
  ) |> 
  
  arrange(desc(companies))
  
owner_quals_high_stock |> 
  
  rename(
    "Owner Qualification"  = "owner_qualification",
    "Companies"            = "companies",
    "Total Capital Stock"  = "total_cap_stock",
    "Mean Capital Stock"   = "mean_cap_stock",
    "Median Capital Stock" = "med_cap_stock"
  ) |> 
  
  datatable(
    options = list(
      autowidth    = TRUE,
      orderClasses = TRUE
    )
  ) |> 
  
  formatCurrency(
    columns  = c("Total Capital Stock",
                 "Mean Capital Stock",
                 "Median Capital Stock"),
    currency = "R$",
    digits   = 2
  )
```

```{r}

ggplot(high_stock_companies,
       aes(x = capital_stock,
           y = reorder(owner_qualification, capital_stock, median),
           fill = owner_qualification)) +
  
  geom_density_ridges(alpha = 0.7, scale = 0.9) +
  
  scale_x_log10(labels = label_number(scale = 1e-9, suffix = "B")) +
  
  labs(
    x     = "Capital Stock (Billions, log scale)",
    y     = "Owner Qualification",
    title = "Capital Stock Distribution by Owner Qualification",
    subtitle = "Top 10% of companies by capital stock"
  ) +
  
  theme_minimal() +
  theme(legend.position = "none")
```

